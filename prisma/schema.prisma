generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Manager {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  managerCode String    @unique
  name        String
  phoneNumber String    @unique
  email       String    @unique
  username    String    @unique
  password    String
  status      AccountStatus @default(ACTIVE)
  address     String
  city        String
  pincode     String 
  createdAt   DateTime  @default(now())
}

model Admin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
}

model Agent {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  agentCode   String   @unique
  name        String
  email       String   @unique
  phoneNumber String   @unique
  username    String   @unique
  password    String
  status      AccountStatus @default(ACTIVE)
  address     String
  city        String
  pincode     String
  createdAt   DateTime @default(now())

  managerId   String   @db.ObjectId
}


enum Role {
  ADMIN
  MANAGER
  AGENT
}

model Customer {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Personal Information
  applicantName String
  guardianName  String
  relationType  RelationType
  religion      Religion

  village       String
  postOffice    String
  policeStation String
  district      String
  pinCode       String

  mobileNumber  String  @unique
  maritalStatus MaritalStatus
  gender        Gender
  dateOfBirth   DateTime

  // Nominee Details
  nomineeName          String
  nomineeMobileNumber  String
  nomineeRelation      NomineeRelation
  nomineeVillage       String
  nomineePostOffice    String
  nomineePoliceStation String
  nomineeDistrict      String
  nomineePinCode       String

  // Nominee Document Details
  nomineePanNumber   String?
  nomineePanImageUrl String

  nomineePoiDocumentType   POIDocumentType
  nomineePoiDocumentNumber String?
  nomineePoiFrontImageUrl  String
  nomineePoiBackImageUrl   String

  nomineePoaDocumentType  POADocumentType
  nomineePoaDocumentNumber String?
  nomineePoaFrontImageUrl String
  nomineePoaBackImageUrl  String

  nomineeSignatureUrl String
  nomineePersonalPhotoUrl      String


  // Document Details
  panNumber   String @unique
  panImageUrl String

  poiDocumentType   POIDocumentType
  poiDocumentNumber String  @unique
  poiFrontImageUrl  String
  poiBackImageUrl   String

  poaDocumentType  POADocumentType
  poaDocumentNumber String  @unique
  poaFrontImageUrl String
  poaBackImageUrl  String

  applicantSignatureUrl String
  personalPhotoUrl      String

  // Account Information
  memberId String @unique
  email    String @unique
  password String

  accountStatus AccountStatus @default(ACTIVE)

  // Relations
  managerId String? @db.ObjectId

  agentId String? @db.ObjectId

  // Meta
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RelationType {
  SO
  WO
  DO
}

enum Religion {
  HINDU
  MUSLIM
  CHRISTIAN
  SIKH
  BUDDHIST
  JAIN
  OTHER
}

enum MaritalStatus {
  MARRIED
  UNMARRIED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum NomineeRelation {
  FATHER
  MOTHER
  SPOUSE
  SON
  DAUGHTER
  BROTHER
  SISTER
  OTHER
}

enum POIDocumentType {
  AADHAR
  VOTER_ID
  DRIVING_LICENSE
  PASSPORT
}

enum POADocumentType {
  AADHAR
  VOTER_ID
  DRIVING_LICENSE
  ELECTRICITY_BILL
  GAS_BILL
  BANK_STATEMENT
}

enum AccountStatus {
  ACTIVE
  INACTIVE
}

model LoanType {
  id                String      @id @map("_id") @default(auto()) @db.ObjectId
  loanName          String      @unique
  status            LoanStatus  @default(ACTIVE)
  description       String?

  // Financial Details
  minAmount         Float
  maxAmount         Float
  interestRate      Float
  interestType      InterestType

  // Processing and Other Charges
  processingFees    Fee
  insuranceFees     Fee
  otherFees         OtherFee[]

  // Loan Duration & Collection
  loanDuration      Int 
  collectionFreq    CollectionFrequency

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

}

enum LoanStatus {
  ACTIVE
  INACTIVE
}

enum InterestType {
  FLAT
  REDUCING_BALANCE
}

enum CollectionFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

// Fees as nested objects
type Fee {
  amount      Float
  isPercentage Boolean
}

type OtherFee {
  amount      Float
  isPercentage Boolean
  description String
}


enum LoanApplicationStatus {
  DRAFT
  SUBMITTED
  CALL_VERIFIED
  CONTRACT_GENERATED
  CONTRACT_SIGNED
  FIELD_VERIFIED
  ADMIN_APPROVED
  DISBURSED
  REJECTED
  CLOSED

  REJECTED_BY_MANAGER
  REJECTED_BY_ADMIN
}

enum FeesPaymentMethod {
  SEPARATE
  DEDUCTED
}

enum DisbursementMethod {
  CASH
  BANK_TRANSFER
}

type FeeSnapshot {
  amount       Float
  isPercentage Boolean
  description  String?
}


type DocumentMeta {
  url           String
  uploadedAt    DateTime
  uploadedById  String
  latitude      Float?
  longitude     Float?
}

type HouseMeta {
  url           String
  uploadedAt    DateTime
  uploadedById  String
  capturedLive  Boolean
  latitude      Float
  longitude     Float
}

type RepaymentSnapshot {
  emiNumber     Int
  dueDate       DateTime
  emiAmount     Float
  paidAmount    Float
  paidDate      DateTime?
  status        String
  transactionId String?
}

model LoanApplication {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  customerId String @db.ObjectId
  loanTypeId String @db.ObjectId
  agentId String @db.ObjectId
  managerId String? @db.ObjectId
  approvedByAdminId String? @db.ObjectId
 
  // Status & Lifecycle
  status LoanApplicationStatus @default(DRAFT)
  rejectionRemark   String?

  submittedAt        DateTime?
  callVerifiedAt     DateTime?
  contractSignedAt   DateTime?
  fieldVerifiedAt    DateTime?
  approvedAt         DateTime?
  disbursedAt        DateTime?

  // Loan Financial Snapshot
  loanAmount         Float
  interestRate       Float
  interestType       InterestType
  loanDuration       Int
  collectionFreq     CollectionFrequency

  // Fees (Frozen Copy)
  processingFees FeeSnapshot
  insuranceFees  FeeSnapshot
  otherFees      FeeSnapshot[]

  feesPaymentMethod FeesPaymentMethod

  // EMI & Interest Calculations
  firstEmiDate        DateTime
  totalInterest       Float
  totalPayableAmount  Float
  disbursedAmount     Float

  remainingAmount    Float

  // Disbursement
  disbursementMethod DisbursementMethod

  // Documents
  vehicleRcDocument        DocumentMeta?
  vehicleInsuranceDocument DocumentMeta?
  contractDocument         DocumentMeta?
  signedContractDocument   DocumentMeta?
  housePhotos              HouseMeta[]

  // Repayment Placeholder
  repayments RepaymentSnapshot[]

  // Meta
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoanFees {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  loanId       String   @db.ObjectId
  customerId   String   @db.ObjectId
  customerName String
  customermobileNumber  String
  totalFees    Float
  paid         Boolean @default(false)
  paymentMethod String?
  transactionId String?
  paidAt        DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
